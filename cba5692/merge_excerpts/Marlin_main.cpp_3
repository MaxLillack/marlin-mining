// EXCERPT FROM MERGE  Marlin/Marlin_main.cpp

<<<<<<< HEAD
static void retract_z_probe() {
  // Retract Z Servo endstop if enabled
  #ifdef SERVO_ENDSTOPS
    if (servo_endstops[Z_AXIS] > -1)
    {
      #if Z_RAISE_AFTER_PROBING > 0
        do_blocking_move_to(current_position[X_AXIS], current_position[Y_AXIS], Z_RAISE_AFTER_PROBING);
        st_synchronize();
      #endif
    
      #if SERVO_LEVELING
        servos[servo_endstops[Z_AXIS]].attach(0);
      #endif
      servos[servo_endstops[Z_AXIS]].write(servo_endstop_angles[Z_AXIS * 2 + 1]);
      #if SERVO_LEVELING
        delay(PROBE_SERVO_DEACTIVATION_DELAY);
        servos[servo_endstops[Z_AXIS]].detach();
      #endif
    }
  #elif defined(Z_PROBE_ALLEN_KEY)
    // Move up for safety
    feedrate = homing_feedrate[X_AXIS];
    destination[Z_AXIS] = current_position[Z_AXIS] + Z_RAISE_AFTER_PROBING;
    prepare_move_raw();

    // Move to the start position to initiate retraction
    destination[X_AXIS] = Z_PROBE_ALLEN_KEY_RETRACT_X;
    destination[Y_AXIS] = Z_PROBE_ALLEN_KEY_RETRACT_Y;
    destination[Z_AXIS] = Z_PROBE_ALLEN_KEY_RETRACT_Z;
    prepare_move_raw();

    // Move the nozzle down to push the probe into retracted position
    feedrate = homing_feedrate[Z_AXIS]/10;
    destination[Z_AXIS] = current_position[Z_AXIS] - Z_PROBE_ALLEN_KEY_RETRACT_DEPTH;
    prepare_move_raw();
    
    // Move up for safety
    feedrate = homing_feedrate[Z_AXIS]/2;
    destination[Z_AXIS] = current_position[Z_AXIS] + Z_PROBE_ALLEN_KEY_RETRACT_DEPTH * 2;
    prepare_move_raw();
    
    // Home XY for safety
    feedrate = homing_feedrate[X_AXIS]/2;
    destination[X_AXIS] = 0;
    destination[Y_AXIS] = 0;
    prepare_move_raw();
    
    st_synchronize();
    
    #if defined(Z_PROBE_AND_ENDSTOP)
    bool z_probe_endstop = (READ(Z_PROBE_PIN) != Z_PROBE_ENDSTOP_INVERTING);
    if (z_probe_endstop)
    #else
    bool z_min_endstop = (READ(Z_MIN_PIN) != Z_MIN_ENDSTOP_INVERTING);
    if (z_min_endstop)
    #endif
    {
        if (!Stopped)
        {
            SERIAL_ERROR_START;
            SERIAL_ERRORLNPGM("Z-Probe failed to retract!");
            LCD_ALERTMESSAGEPGM("Err: ZPROBE");
=======
  }

  static void retract_z_probe(const float z_after=Z_RAISE_AFTER_PROBING) {

    #ifdef SERVO_ENDSTOPS

      // Retract Z Servo endstop if enabled
      if (servo_endstops[Z_AXIS] >= 0) {

        if (z_after > 0) {
          do_blocking_move_to(current_position[X_AXIS], current_position[Y_AXIS], z_after);
          st_synchronize();
>>>>>>> baa678739388d39b5619f73bc3715e5ab71bf21e

